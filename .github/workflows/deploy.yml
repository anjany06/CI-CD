name: Deploy Next.js to EC2
run-name: ${{ github.actor }} is deploying Next.js app ðŸš€

on:
  push:
    branches: [main, master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
          cache-dependency-path: next-aws-deploy/package-lock.json

      - name: Install and build on GitHub Actions
        working-directory: next-aws-deploy
        run: |
          npm ci
          npm run build

      - name: Create production package (only built files)
        run: |
          cd next-aws-deploy
          mkdir -p deploy-package
          cp -r .next deploy-package/
          cp -r public deploy-package/ 2>/dev/null || true
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp next.config.* deploy-package/ 2>/dev/null || true
          tar -czf ../deploy.tar.gz -C deploy-package .

      - name: Copy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 51.21.195.178
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 51.21.195.178
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          script: |
            # Install Node.js once (if not installed)
            if ! command -v node >/dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Install PM2 once (if not installed)
            if ! command -v pm2 >/dev/null; then
              sudo npm install -g pm2
            fi

            # Stop old app
            pm2 stop nextjs-app 2>/dev/null || true
            pm2 delete nextjs-app 2>/dev/null || true

            # Deploy new version
            rm -rf ~/nextjs-app
            mkdir -p ~/nextjs-app
            tar -xzf /tmp/deploy.tar.gz -C ~/nextjs-app
            cd ~/nextjs-app

            # Install ONLY production dependencies (much faster, less memory)
            npm ci --omit=dev --ignore-scripts

            # Start app
            pm2 start npm --name "nextjs-app" -- start
            pm2 save
            pm2 startup

            # Cleanup
            rm /tmp/deploy.tar.gz

            echo "âœ… Deployed! Visit: http://51.21.195.178:3000"
