name: Deploy Next.js to EC2
run-name: ${{ github.actor }} is deploying Next.js app ğŸš€

on:
  push:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
          cache-dependency-path: next-aws-deploy/package-lock.json

      - name: Install dependencies
        working-directory: next-aws-deploy
        run: npm ci

      - name: Run linter
        working-directory: next-aws-deploy
        run: npm run lint || true

      - name: Build application
        working-directory: next-aws-deploy
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
          cache-dependency-path: next-aws-deploy/package-lock.json

      - name: Install dependencies and build
        working-directory: next-aws-deploy
        run: |
          npm ci
          npm run build

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz -C next-aws-deploy --exclude=node_modules --exclude=.git .

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 51.21.195.178
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          source: "deployment.tar.gz"
          target: "/tmp/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 51.21.195.178
          username: ubuntu
          key: ${{ secrets.PRIVATE_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "ğŸ“‹ System Check..."

            # Install Node.js if needed
            if ! command -v node >/dev/null 2>&1; then
              echo "ğŸ“¦ Installing Node.js 18..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "âœ… Node: $(node --version)"
            echo "âœ… NPM: $(npm --version)"

            # Install PM2 if needed
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "ğŸ“¦ Installing PM2..."
              sudo npm install -g pm2
            fi
            echo "âœ… PM2: $(pm2 --version)"

            # Stop existing app
            echo "â¹ï¸  Stopping existing app..."
            pm2 stop nextjs-app 2>/dev/null || echo "No existing app to stop"

            # Backup current deployment
            echo "ğŸ’¾ Creating backup..."
            rm -rf ~/app-backup 2>/dev/null || true
            [ -d ~/my-app ] && mv ~/my-app ~/app-backup || true

            # Extract new deployment
            echo "ğŸ“‚ Extracting deployment..."
            mkdir -p ~/my-app
            tar -xzf /tmp/deployment.tar.gz -C ~/my-app
            cd ~/my-app

            # Install dependencies
            echo "ğŸ“¥ Installing dependencies..."
            npm ci --omit=dev

            # Build application
            echo "ğŸ”¨ Building application..."
            npm run build

            # Start with PM2
            echo "ğŸŸ¢ Starting application..."
            pm2 start npm --name "nextjs-app" -- start
            pm2 save

            # Setup PM2 to start on boot
            sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u $USER --hp /home/$USER || true

            # Show status
            echo ""
            echo "âœ… Deployment completed!"
            pm2 status

            # Cleanup
            rm -f /tmp/deployment.tar.gz

            echo ""
            echo "ğŸŒ Your app is running!"
            echo "Access it at: http://51.21.195.178:3000"
